<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø³Ø±Ú† Ú©Ù†Ø³ÙˆÙ„ - GSC Reports</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: #07111f;
      color: #e7eaf3;
      margin: 0;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      background: #0d1830;
      border-bottom: 1px solid #1f2a44;
    }
    
    .brand {
      font-weight: 700;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    
    .page-header {
      margin-bottom: 32px;
    }
    
    .page-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #10b981;
    }
    
    .page-subtitle {
      color: #a0aec0;
      font-size: 16px;
      margin: 0;
    }
    
    .controls {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 20px;
    }
    
    select, button {
      padding: 10px 14px;
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 6px;
      color: #e7eaf3;
      font-size: 14px;
    }
    
    button {
      background: #10b981;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #059669;
    }
    
    button:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }
    
    .report-section {
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .report-section h3 {
      margin: 0 0 20px 0;
      color: #93c5fd;
      font-size: 20px;
      border-bottom: 1px solid #1f2a44;
      padding-bottom: 12px;
    }
    
    .summary-box {
      background: #0a1520;
      border: 1px solid #1f2a44;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 24px;
    }
    
    .summary-box h4 {
      margin: 0 0 12px 0;
      color: #10b981;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #1f2a44;
    }
    
    .summary-item:last-child {
      border-bottom: none;
    }
    
    .summary-label {
      color: #a0aec0;
    }
    
    .summary-value {
      color: #e7eaf3;
      font-weight: 600;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #1f2a44;
    }
    
    th {
      color: #93c5fd;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
    }
    
    td {
      font-size: 14px;
    }
    
    tr:hover {
      background: rgba(16, 185, 129, 0.1);
    }
    
    .page-url {
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #93c5fd;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-positive {
      background: #10b981;
      color: white;
    }
    
    .badge-negative {
      background: #ef4444;
      color: white;
    }
    
    .badge-neutral {
      background: #6b7280;
      color: white;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
    }
    
    .error {
      background: #ef4444;
      color: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: #a0aec0;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    a {
      color: #93c5fd;
      text-decoration: none;
    }
    
    a:hover {
      text-decoration: underline;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #10b981;
      color: white;
      border-radius: 6px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s;
    }
    
    .btn:hover {
      background: #059669;
      text-decoration: none;
    }
    
    .info-box {
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .info-box h3 {
      margin: 0 0 12px 0;
      color: #93c5fd;
    }
    
    .info-box p {
      margin: 0;
      color: #a0aec0;
      line-height: 1.6;
    }
    
    /* Filter and Search Styles */
    .table-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .table-controls input[type="text"],
    .table-controls select {
      padding: 8px 12px;
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 6px;
      color: #e7eaf3;
      font-size: 14px;
    }
    
    .table-controls input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    
    .table-controls button {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    .export-btn {
      background: #3b82f6;
    }
    
    .export-btn:hover {
      background: #2563eb;
    }
    
    /* Pagination Styles */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      padding: 16px;
    }
    
    .pagination button {
      padding: 8px 12px;
      min-width: 40px;
    }
    
    .pagination .page-info {
      color: #a0aec0;
      padding: 0 12px;
    }
    
    /* Alert Badges */
    .badge-alert {
      background: #ef4444;
      color: white;
      animation: pulse 2s infinite;
    }
    
    .badge-warning {
      background: #f59e0b;
      color: white;
    }
    
    .badge-info {
      background: #3b82f6;
      color: white;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Performance Insights */
    .insights-box {
      background: #0a1520;
      border: 1px solid #1f2a44;
      border-left: 4px solid #10b981;
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .insights-box h4 {
      margin: 0 0 12px 0;
      color: #10b981;
    }
    
    .insight-item {
      padding: 8px 0;
      border-bottom: 1px solid #1f2a44;
    }
    
    .insight-item:last-child {
      border-bottom: none;
    }
    
    .insight-priority {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
    
    .priority-high {
      background: #ef4444;
      color: white;
    }
    
    .priority-medium {
      background: #f59e0b;
      color: white;
    }
    
    .priority-low {
      background: #6b7280;
      color: white;
    }
    
    /* Date Range Picker */
    .date-range-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .date-range-controls input[type="date"] {
      padding: 10px 14px;
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 6px;
      color: #e7eaf3;
      font-size: 14px;
    }
    
    .date-range-controls label {
      color: #a0aec0;
      font-size: 14px;
    }
    
    /* Chart Container */
    .chart-container {
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      height: 400px;
    }
    
    /* Sortable Table Headers */
    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    th.sortable:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    th.sortable::after {
      content: ' â†•';
      opacity: 0.5;
      font-size: 12px;
    }
    
    th.sortable.asc::after {
      content: ' â†‘';
      opacity: 1;
    }
    
    th.sortable.desc::after {
      content: ' â†“';
      opacity: 1;
    }
    
    /* Historical Reports */
    .saved-reports {
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .saved-report-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #1f2a44;
      cursor: pointer;
    }
    
    .saved-report-item:hover {
      background: rgba(139, 92, 246, 0.1);
    }
    
    .saved-report-item:last-child {
      border-bottom: none;
    }
    
    /* Collapsible Sections */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 16px;
      background: rgba(16, 185, 129, 0.1);
      border-radius: 6px;
      margin-bottom: 12px;
      transition: background 0.2s;
    }
    
    .section-header:hover {
      background: rgba(16, 185, 129, 0.2);
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #93c5fd;
      margin: 0;
    }
    
    .toggle-icon {
      font-size: 20px;
      color: #a0aec0;
      transition: transform 0.3s;
    }
    
    .section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    
    .section-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      max-height: 10000px;
    }
    
    .section-content.collapsed {
      max-height: 0;
      overflow: hidden;
    }
    
    /* Email Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
    }
    
    .modal-content {
      background: #0d1830;
      border: 1px solid #1f2a44;
      border-radius: 8px;
      padding: 24px;
      margin: 10% auto;
      max-width: 500px;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #93c5fd;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: #a0aec0;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-modal:hover {
      color: #e7eaf3;
    }
    
    .modal-body input {
      width: 100%;
      padding: 12px;
      background: #0a1520;
      border: 1px solid #1f2a44;
      border-radius: 6px;
      color: #e7eaf3;
      font-size: 14px;
      margin-bottom: 16px;
      box-sizing: border-box;
    }
    
    .modal-body input:focus {
      outline: none;
      border-color: #10b981;
    }
    
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .modal-footer button {
      padding: 10px 20px;
    }
    
    .modal-footer button.cancel {
      background: #4b5563;
    }
    
    .modal-footer button.cancel:hover {
      background: #6b7280;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">SEO Tools</div>
    <nav>
      <span>Signed in as {{ username }}</span>
      &nbsp; | &nbsp;
      <a href="/dashboard">Dashboard</a> &nbsp; | &nbsp;
      <a href="/search-console/">Search Console</a> &nbsp; | &nbsp;
      <a href="/logout">Logout</a>
    </nav>
  </header>
  
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø³Ø±Ú† Ú©Ù†Ø³ÙˆÙ„</h1>
      <p class="page-subtitle">GSC Reports - Advanced Analytics & Reporting</p>
    </div>
    
    {% if not has_connection %}
      <div class="info-box">
        <h3>âš ï¸ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Search Console</h3>
        <p>
          Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯Ø²Ø§Ø±Ø´Ø§ØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Google Search Console Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.
          <br>
          <a href="/search-console/connect" class="btn" style="margin-top: 16px;">Ø§ØªØµØ§Ù„ Ø¨Ù‡ Search Console</a>
        </p>
      </div>
    {% else %}
      <div class="controls">
        <select id="propertySelect">
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Property...</option>
          {% for prop in properties %}
            <option value="{{ prop }}">{{ prop }}</option>
          {% endfor %}
        </select>
        
        <select id="dateRangeType" onchange="toggleDateRangeType()">
          <option value="preset" selected>Ø¨Ø§Ø²Ù‡ Ø§Ø² Ù¾ÛŒØ´ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡</option>
          <option value="custom">Ø¨Ø§Ø²Ù‡ Ø¯Ù„Ø®ÙˆØ§Ù‡</option>
        </select>
        
        <div id="presetDateRange">
          <select id="daysSelect">
            <option value="7">Ø¢Ø®Ø±ÛŒÙ† 7 Ø±ÙˆØ²</option>
            <option value="14">Ø¢Ø®Ø±ÛŒÙ† 14 Ø±ÙˆØ²</option>
            <option value="30" selected>Ø¢Ø®Ø±ÛŒÙ† 30 Ø±ÙˆØ²</option>
            <option value="90">Ø¢Ø®Ø±ÛŒÙ† 90 Ø±ÙˆØ²</option>
          </select>
        </div>
        
        <div id="customDateRange" style="display: none;" class="date-range-controls">
          <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
          <input type="date" id="startDate">
          <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
          <input type="date" id="endDate">
        </div>
        
        <button onclick="generateReports()" id="generateBtn">ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª</button>
        <button onclick="generateInternalLinks()" id="internalLinksBtn">ØªØ­Ù„ÛŒÙ„ Internal Links</button>
      </div>
      
      <div class="controls" style="margin-top: 16px;">
        <input type="text" id="queryInput" placeholder="ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Query..." style="flex: 1; padding: 10px 14px; background: #0d1830; border: 1px solid #1f2a44; border-radius: 6px; color: #e7eaf3; font-size: 14px;">
        <button onclick="searchPagesByQuery()" id="querySearchBtn">Ø¬Ø³ØªØ¬ÙˆÛŒ ØµÙØ­Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Query</button>
      </div>
      
      <div id="messageArea"></div>
      
      <!-- Historical Reports Section -->
      <div id="historyArea"></div>
      
      <div id="reportsArea"></div>
    {% endif %}
  </div>
  
  <!-- Email Modal -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„</h3>
        <button class="close-modal" onclick="closeEmailModal()">&times;</button>
      </div>
      <div class="modal-body">
        <label style="display: block; margin-bottom: 8px; color: #a0aec0;">Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„:</label>
        <input type="email" id="emailInput" placeholder="example@email.com" required>
        <div style="color: #a0aec0; font-size: 12px; margin-top: -12px; margin-bottom: 16px;">
          Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel" onclick="closeEmailModal()">Ø§Ù†ØµØ±Ø§Ù</button>
        <button onclick="sendReportByEmail()">Ø§Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>
  
  <script>
    // Load historical reports on page load
    document.addEventListener('DOMContentLoaded', function() {
      const historyArea = document.getElementById('historyArea');
      if (historyArea) {
        const historyHtml = loadReportHistory();
        if (historyHtml) {
          historyArea.innerHTML = historyHtml;
        }
      }
    });
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Global state
    let currentReportsData = null;
    let currentPage = 1;
    const itemsPerPage = 999999; // Show all results
    
    function showMessage(text, type = 'error') {
      const area = document.getElementById('messageArea');
      const className = type === 'error' ? 'error' : 'success';
      area.innerHTML = `<div class="${className}">${text}</div>`;
      setTimeout(() => {
        area.innerHTML = '';
      }, 5000);
    }
    
    function toggleDateRangeType() {
      const type = document.getElementById('dateRangeType').value;
      const preset = document.getElementById('presetDateRange');
      const custom = document.getElementById('customDateRange');
      
      if (type === 'preset') {
        preset.style.display = 'block';
        custom.style.display = 'none';
      } else {
        preset.style.display = 'none';
        custom.style.display = 'flex';
        // Set default dates (last 30 days)
        const endDate = new Date();
        endDate.setDate(endDate.getDate() - 1); // GSC has 1-2 day delay
        const startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - 29);
        
        document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
      }
    }
    
    function getDateRange() {
      const type = document.getElementById('dateRangeType').value;
      if (type === 'preset') {
        const days = parseInt(document.getElementById('daysSelect').value);
        const endDate = new Date();
        endDate.setDate(endDate.getDate() - 1);
        const startDate = new Date(endDate);
        startDate.setDate(startDate.getDate() - (days - 1));
        return {
          start: startDate.toISOString().split('T')[0],
          end: endDate.toISOString().split('T')[0],
          days: days
        };
      } else {
        return {
          start: document.getElementById('startDate').value,
          end: document.getElementById('endDate').value,
          days: null
        };
      }
    }
    
    // Export to CSV
    function exportToCSV(tableId, filename) {
      const table = document.querySelector(`#${tableId} table`);
      if (!table) {
        showMessage('Ø¬Ø¯ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ export ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
        return;
      }
      
      let csv = [];
      const rows = table.querySelectorAll('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
          let data = cols[j].innerText.replace(/"|'/g, '');
          data = data.replace(/,/g, ';');
          row.push('"' + data + '"');
        }
        
        csv.push(row.join(','));
      }
      
      const csvContent = csv.join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename || 'report.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Filter and Search
    function filterTable(tableId, searchTerm, filterColumn, filterValue) {
      const table = document.querySelector(`#${tableId} table tbody`);
      if (!table) return;
      
      const rows = table.querySelectorAll('tr');
      let visibleCount = 0;
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        let show = true;
        
        // Search filter
        if (searchTerm) {
          const text = row.innerText.toLowerCase();
          if (!text.includes(searchTerm.toLowerCase())) {
            show = false;
          }
        }
        
        // Column filter
        if (filterColumn !== null && filterValue) {
          const cellValue = cells[filterColumn]?.innerText || '';
          if (!cellValue.includes(filterValue)) {
            show = false;
          }
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
      });
      
      return visibleCount;
    }
    
    // Sortable table
    function makeSortable(tableId) {
      const table = document.querySelector(`#${tableId} table`);
      if (!table) return;
      
      const headers = table.querySelectorAll('thead th');
      headers.forEach((header, index) => {
        if (header.classList.contains('sortable')) {
          header.addEventListener('click', () => {
            sortTable(tableId, index, header);
          });
        }
      });
    }
    
    function sortTable(tableId, columnIndex, header) {
      const table = document.querySelector(`#${tableId} table tbody`);
      if (!table) return;
      
      const rows = Array.from(table.querySelectorAll('tr'));
      const isAsc = header.classList.contains('asc');
      
      // Remove all sort classes
      header.parentElement.querySelectorAll('th').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      
      // Add sort class
      header.classList.add(isAsc ? 'desc' : 'asc');
      
      // Sort rows
      rows.sort((a, b) => {
        const aText = a.querySelectorAll('td')[columnIndex]?.innerText || '';
        const bText = b.querySelectorAll('td')[columnIndex]?.innerText || '';
        
        // Try to parse as number
        const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
        const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return isAsc ? bNum - aNum : aNum - bNum;
        }
        
        return isAsc ? bText.localeCompare(aText) : aText.localeCompare(bText);
      });
      
      // Re-append sorted rows
      rows.forEach(row => table.appendChild(row));
    }
    
    // Pagination
    function paginateTable(tableId, page) {
      const table = document.querySelector(`#${tableId} table tbody`);
      if (!table) return;
      
      const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
      const totalPages = Math.ceil(rows.length / itemsPerPage);
      
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      
      currentPage = page;
      
      const start = (page - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      
      rows.forEach((row, index) => {
        if (index >= start && index < end) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      
      return { currentPage: page, totalPages, totalItems: rows.length };
    }
    
    function createPagination(tableId, pageInfo) {
      if (pageInfo.totalPages <= 1) return '';
      
      let html = '<div class="pagination">';
      html += `<button onclick="paginateTable('${tableId}', ${pageInfo.currentPage - 1})" ${pageInfo.currentPage === 1 ? 'disabled' : ''}>Ù‚Ø¨Ù„ÛŒ</button>`;
      html += `<span class="page-info">ØµÙØ­Ù‡ ${pageInfo.currentPage} Ø§Ø² ${pageInfo.totalPages} (${pageInfo.totalItems} Ù†ØªÛŒØ¬Ù‡)</span>`;
      html += `<button onclick="paginateTable('${tableId}', ${pageInfo.currentPage + 1})" ${pageInfo.currentPage === pageInfo.totalPages ? 'disabled' : ''}>Ø¨Ø¹Ø¯ÛŒ</button>`;
      html += '</div>';
      
      return html;
    }
    
    // Performance Insights Generator
    function generateInsights(reports) {
      const insights = [];
      
      // High priority: Zero clicks with high impressions
      if (reports.high_impressions_zero_clicks && reports.high_impressions_zero_clicks.length > 0) {
        insights.push({
          priority: 'high',
          message: `${reports.high_impressions_zero_clicks.length} ØµÙØ­Ù‡ Ø¨Ø§ Impression Ø¨Ø§Ù„Ø§ ÙˆÙ„ÛŒ 0 Click Ø¯Ø§Ø±Ù† - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ Title Ùˆ Meta Description`,
          action: 'Ø¨Ù‡Ø¨ÙˆØ¯ Title Ùˆ Meta Description Ø¨Ø±Ø§ÛŒ Ø§ÙØ²Ø§ÛŒØ´ CTR'
        });
      }
      
      // High priority: Significant click drops
      if (reports.clicks_decreased_25pct && reports.clicks_decreased_25pct.length > 0) {
        insights.push({
          priority: 'high',
          message: `${reports.clicks_decreased_25pct.length} ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ø§Ù‡Ø´ Ø¨ÛŒØ´ Ø§Ø² 25% Ø¯Ø± Clicks`,
          action: 'Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø®ÛŒØ±ØŒ Ø±Ù‚Ø¨Ø§ØŒ Ùˆ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ú¯ÙˆÚ¯Ù„'
        });
      }
      
      // Medium priority: Low CTR
      if (reports.lowest_ctr && reports.lowest_ctr.length > 0) {
        const avgCTR = reports.lowest_ctr.reduce((sum, p) => sum + p.ctr, 0) / reports.lowest_ctr.length;
        if (avgCTR < 2) {
          insights.push({
            priority: 'medium',
            message: `CTR Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† ${avgCTR.toFixed(2)}% - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯`,
            action: 'Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Title Ùˆ Meta Description Ø¨Ø±Ø§ÛŒ Ø¬Ø°Ø§Ø¨â€ŒØªØ± Ø´Ø¯Ù†'
          });
        }
      }
      
      // Low priority: High position but clicks
      if (reports.clicks_high_position && reports.clicks_high_position.length > 0) {
        insights.push({
          priority: 'low',
          message: `${reports.clicks_high_position.length} ØµÙØ­Ù‡ Ø¨Ø§ Position Ø¨Ø§Ù„Ø§ÛŒ 6 ÙˆÙ„ÛŒ Click Ø¯Ø§Ø±Ù† - Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ù‡Ø¨ÙˆØ¯`,
          action: 'Ø¨Ù‡Ø¨ÙˆØ¯ On-page SEO Ùˆ Ø³Ø§Ø®Øª Backlink Ø¨Ø±Ø§ÛŒ Ø¨Ù‡Ø¨ÙˆØ¯ Position'
        });
      }
      
      return insights;
    }
    
    function generateReports() {
      const siteUrl = document.getElementById('propertySelect').value;
      const dateRange = getDateRange();
      const btn = document.getElementById('generateBtn');
      
      if (!siteUrl) {
        showMessage('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Property Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      if (dateRange.start && dateRange.end && new Date(dateRange.start) > new Date(dateRange.end)) {
        showMessage('ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§ÛŒØ¯ Ù‚Ø¨Ù„ Ø§Ø² ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø´Ø¯', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª...';
      
      const reportsArea = document.getElementById('reportsArea');
      reportsArea.innerHTML = '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...</div>';
      
      const requestBody = {
        site_url: siteUrl
      };
      
      if (dateRange.days) {
        requestBody.days = dateRange.days;
      } else {
        requestBody.start_date = dateRange.start;
        requestBody.end_date = dateRange.end;
      }
      
      fetch('/search-console/reports/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.textContent = 'ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª';
        
        if (data.error) {
          showMessage(data.error, 'error');
          reportsArea.innerHTML = '';
          return;
        }
        
        currentReportsData = data;
        displayReports(data);
        saveReportToHistory(data);
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = 'ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª';
        showMessage('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª: ' + error.message, 'error');
        reportsArea.innerHTML = '';
      });
    }
    
    function generateInternalLinks() {
      const siteUrl = document.getElementById('propertySelect').value;
      const days = document.getElementById('daysSelect').value;
      const btn = document.getElementById('internalLinksBtn');
      
      if (!siteUrl) {
        showMessage('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Property Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...';
      
      fetch('/search-console/reports/internal-links', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          site_url: siteUrl,
          days: parseInt(days),
          limit: 50
        })
      })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.textContent = 'ØªØ­Ù„ÛŒÙ„ Internal Links';
        
        if (data.error) {
          showMessage(data.error, 'error');
          return;
        }
        
        displayInternalLinks(data);
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = 'ØªØ­Ù„ÛŒÙ„ Internal Links';
        showMessage('Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Internal Links: ' + error.message, 'error');
      });
    }
    
    // Helper function to create table with controls
    function createTableSection(sectionId, title, headers, data, getRowHtml, showExport = true, showFilter = true) {
      if (!data || data.length === 0) return '';
      
      let html = `<div class="report-section" id="${sectionId}">`;
      
      // Collapsible header
      html += `
        <div class="section-header" onclick="toggleSection('${sectionId}')">
          <h3 class="section-title">${title} <span style="color: #a0aec0; font-size: 14px; font-weight: normal;">(${data.length} Ù†ØªÛŒØ¬Ù‡)</span></h3>
          <span class="toggle-icon">â–¼</span>
        </div>
      `;
      
      // Collapsible content
      html += `<div class="section-content" id="${sectionId}_content">`;
      
      if (showFilter || showExport) {
        html += `<div class="table-controls">`;
        if (showFilter) {
          html += `<input type="text" id="${sectionId}_search" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." onkeyup="filterTable('${sectionId}', this.value, null, null)">`;
        }
        if (showExport) {
          html += `<button class="export-btn" onclick="exportToCSV('${sectionId}', '${title.replace(/[^a-z0-9]/gi, '_')}.csv')">ğŸ“¥ Export CSV</button>`;
        }
        html += `</div>`;
      }
      
      html += `<table>`;
      html += `<thead><tr>`;
      headers.forEach((header, index) => {
        html += `<th class="sortable" onclick="sortTable('${sectionId}', ${index}, this)">${header}</th>`;
      });
      html += `</tr></thead>`;
      html += `<tbody>`;
      
      data.forEach((item, index) => {
        html += getRowHtml(item, index);
      });
      
      html += `</tbody></table>`;
      html += `</div>`; // Close section-content
      html += `</div>`; // Close report-section
      
      return html;
    }
    
    // Toggle section collapse/expand
    function toggleSection(sectionId) {
      const header = document.querySelector(`#${sectionId} .section-header`);
      const content = document.getElementById(`${sectionId}_content`);
      
      if (header && content) {
        header.classList.toggle('collapsed');
        content.classList.toggle('collapsed');
      }
    }
    
    // Helper to get alert badge
    function getAlertBadge(page) {
      if (page.clicks === 0 && page.impressions > 100) {
        return '<span class="badge badge-alert">âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡</span>';
      }
      if (page.ctr < 1 && page.impressions > 50) {
        return '<span class="badge badge-warning">âš ï¸ CTR Ù¾Ø§ÛŒÛŒÙ†</span>';
      }
      if (page.position > 10 && page.clicks > 0) {
        return '<span class="badge badge-info">â„¹ï¸ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ù‡Ø¨ÙˆØ¯</span>';
      }
      return '';
    }
    
    function displayReports(data) {
      const reportsArea = document.getElementById('reportsArea');
      let html = '';
      
      // Summary with chart
      html += `
        <div class="summary-box">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h4 style="margin: 0;">Ø®Ù„Ø§ØµÙ‡ Ú¯Ø²Ø§Ø±Ø´Ø§Øª</h4>
            <button onclick="openEmailModal()" style="background: #3b82f6; padding: 8px 16px; font-size: 14px;">ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„</button>
          </div>
          <div class="summary-item">
            <span class="summary-label">Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ:</span>
            <span class="summary-value">${data.period}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">ØªØºÛŒÛŒØ± Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Position:</span>
            <span class="summary-value">${data.avg_position_change > 0 ? '+' : ''}${data.avg_position_change}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Ø¯ÙˆØ±Ù‡ Ù‚Ø¨Ù„ÛŒ:</span>
            <span class="summary-value">${data.previous_period}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Ø¯ÙˆØ±Ù‡ ÙØ¹Ù„ÛŒ:</span>
            <span class="summary-value">${data.current_period}</span>
          </div>
        </div>
      `;
      
      // Performance Insights - collapsible
      const insights = generateInsights(data.reports);
      if (insights.length > 0) {
        html += `
          <div class="report-section">
            <div class="section-header" onclick="toggleSection('insights_section')">
              <h3 class="section-title">ğŸ’¡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ùˆ Insights</h3>
              <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content" id="insights_section_content">
              <div class="insights-box" style="margin-top: 0;">
        `;
        insights.forEach(insight => {
          html += `<div class="insight-item">`;
          html += `<span>${insight.message}</span>`;
          html += `<span class="insight-priority priority-${insight.priority}">${insight.priority === 'high' ? 'Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§' : insight.priority === 'medium' ? 'Ø§ÙˆÙ„ÙˆÛŒØª Ù…ØªÙˆØ³Ø·' : 'Ø§ÙˆÙ„ÙˆÛŒØª Ù¾Ø§ÛŒÛŒÙ†'}</span>`;
          html += `<div style="color: #a0aec0; font-size: 12px; margin-top: 4px;">â†’ ${insight.action}</div>`;
          html += `</div>`;
        });
        html += `
              </div>
            </div>
          </div>
        `;
      }
      
      // Charts - collapsible
      if (data.reports && data.reports.highest_ctr && data.reports.highest_ctr.length > 0) {
        html += `
          <div class="report-section">
            <div class="section-header" onclick="toggleSection('charts_section')">
              <h3 class="section-title">ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ Ùˆ Visualizations</h3>
              <span class="toggle-icon">â–¼</span>
            </div>
            <div class="section-content" id="charts_section_content">
              ${createCharts(data)}
            </div>
          </div>
        `;
      }
      
      const reports = data.reports;
      
      // 1. High impressions, low clicks
      if (reports.high_impressions_low_clicks && reports.high_impressions_low_clicks.length > 0) {
        html += createTableSection(
          'high_imp_low_clicks',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Impression Ùˆ Ú©Ù…ØªØ±ÛŒÙ† Click (ØºÛŒØ± ØµÙØ±)',
          ['ØµÙØ­Ù‡', 'Impressions', 'Clicks', 'CTR', 'Position', ''],
          reports.high_impressions_low_clicks,
          (page, index) => {
            const badge = getAlertBadge(page);
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.ctr}%</td>
                <td>${page.position}</td>
                <td>${badge}</td>
              </tr>
            `;
          }
        );
      }
      
      // 2. High impressions, zero clicks
      if (reports.high_impressions_zero_clicks && reports.high_impressions_zero_clicks.length > 0) {
        html += createTableSection(
          'high_imp_zero_clicks',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Impression Ùˆ 0 Click',
          ['ØµÙØ­Ù‡', 'Impressions', 'Clicks', 'CTR', 'Position', ''],
          reports.high_impressions_zero_clicks,
          (page, index) => {
            const badge = getAlertBadge(page);
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.ctr}%</td>
                <td>${page.position}</td>
                <td>${badge}</td>
              </tr>
            `;
          }
        );
      }
      
      // 3. Clicks decreased > 25%
      if (reports.clicks_decreased_25pct && reports.clicks_decreased_25pct.length > 0) {
        html += createTableSection(
          'clicks_decreased',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ø§Ù‡Ø´ Ø¨ÛŒØ´ Ø§Ø² 25% Ø¯Ø± Clicks',
          ['ØµÙØ­Ù‡', 'Clicks Ù‚Ø¨Ù„ÛŒ', 'Clicks ÙØ¹Ù„ÛŒ', 'ØªØºÛŒÛŒØ±', 'Position', ''],
          reports.clicks_decreased_25pct,
          (page, index) => {
            const changePercent = page.clicks_change_percent.toFixed(1);
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.previous_clicks ? page.previous_clicks.toLocaleString() : 0}</td>
                <td>${page.current_clicks ? page.current_clicks.toLocaleString() : 0}</td>
                <td><span class="badge badge-negative">${changePercent}%</span></td>
                <td>${page.current_position || page.position || '-'}</td>
                <td><span class="badge badge-alert">âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ</span></td>
              </tr>
            `;
          }
        );
      }
      
      // 4. Highest clicks
      if (reports.highest_clicks && reports.highest_clicks.length > 0) {
        html += createTableSection(
          'highest_clicks',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Click',
          ['ØµÙØ­Ù‡', 'Clicks', 'Impressions', 'CTR', 'Position', ''],
          reports.highest_clicks,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td><span class="badge badge-positive">${page.ctr}%</span></td>
                <td>${page.position}</td>
                <td><span class="badge badge-positive">âœ… Ø¨Ù‡ØªØ±ÛŒÙ† Ø¹Ù…Ù„Ú©Ø±Ø¯</span></td>
              </tr>
            `;
          }
        );
      }
      
      // 5. Lowest impressions and clicks
      if (reports.lowest_impressions_clicks && reports.lowest_impressions_clicks.length > 0) {
        html += createTableSection(
          'lowest_imp_clicks',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ù…ØªØ±ÛŒÙ† Impression Ùˆ Click (ØºÛŒØ± ØµÙØ±)',
          ['ØµÙØ­Ù‡', 'Impressions', 'Clicks', 'CTR', 'Position', ''],
          reports.lowest_impressions_clicks,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.ctr}%</td>
                <td>${page.position}</td>
                <td>${getAlertBadge(page)}</td>
              </tr>
            `;
          }
        );
      }
      
      // 6. Highest CTR
      if (reports.highest_ctr && reports.highest_ctr.length > 0) {
        html += createTableSection(
          'highest_ctr',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† CTR',
          ['ØµÙØ­Ù‡', 'CTR', 'Clicks', 'Impressions', 'Position', ''],
          reports.highest_ctr,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td><span class="badge badge-positive">${page.ctr}%</span></td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.position}</td>
                <td><span class="badge badge-positive">âœ… Ø¨Ù‡ØªØ±ÛŒÙ† CTR</span></td>
              </tr>
            `;
          }
        );
      }
      
      // 7. Lowest CTR
      if (reports.lowest_ctr && reports.lowest_ctr.length > 0) {
        html += createTableSection(
          'lowest_ctr',
          '5 ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ù…ØªØ±ÛŒÙ† CTR',
          ['ØµÙØ­Ù‡', 'CTR', 'Clicks', 'Impressions', 'Position', ''],
          reports.lowest_ctr,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td><span class="badge badge-negative">${page.ctr}%</span></td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.position}</td>
                <td><span class="badge badge-warning">âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯</span></td>
              </tr>
            `;
          }
        );
      }
      
      // 8. Zero clicks, low CTR
      if (reports.zero_clicks_low_ctr && reports.zero_clicks_low_ctr.length > 0) {
        html += createTableSection(
          'zero_clicks_low_ctr',
          'ØµÙØ­Ø§ØªÛŒ Ø¨Ø§ 0 Click Ùˆ CTR Ø²ÛŒØ± 10%',
          ['ØµÙØ­Ù‡', 'Impressions', 'Clicks', 'CTR', 'Position', ''],
          reports.zero_clicks_low_ctr,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.ctr}%</td>
                <td>${page.position}</td>
                <td><span class="badge badge-alert">âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡ ÙÙˆØ±ÛŒ</span></td>
              </tr>
            `;
          }
        );
      }
      
      // 9. Clicks with position > 6
      if (reports.clicks_high_position && reports.clicks_high_position.length > 0) {
        html += createTableSection(
          'clicks_high_position',
          'ØµÙØ­Ø§ØªÛŒ Ø¨Ø§ Click Ùˆ Position Ø¨Ø§Ù„Ø§ÛŒ 6',
          ['ØµÙØ­Ù‡', 'Position', 'Clicks', 'Impressions', 'CTR', ''],
          reports.clicks_high_position,
          (page, index) => {
            return `
              <tr>
                <td class="page-url" title="${page.page}">${index + 1}. ${page.page}</td>
                <td>${page.position}</td>
                <td>${page.clicks.toLocaleString()}</td>
                <td>${page.impressions.toLocaleString()}</td>
                <td>${page.ctr}%</td>
                <td><span class="badge badge-info">â„¹ï¸ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ù‡Ø¨ÙˆØ¯ Position</span></td>
              </tr>
            `;
          }
        );
      }
      
      reportsArea.innerHTML = html;
      
      // Initialize sortable tables
      setTimeout(() => {
        ['high_imp_low_clicks', 'high_imp_zero_clicks', 'clicks_decreased', 'highest_clicks', 
         'lowest_imp_clicks', 'highest_ctr', 'lowest_ctr', 'zero_clicks_low_ctr', 'clicks_high_position'].forEach(id => {
          makeSortable(id);
        });
      }, 100);
    }
    
    // Create charts
    function createCharts(data) {
      if (!data.reports) return '';
      
      let html = '<div class="chart-container">';
      html += '<canvas id="ctrChart"></canvas>';
      html += '</div>';
      
      // Chart will be rendered after DOM is ready
      setTimeout(() => {
        const ctx = document.getElementById('ctrChart');
        if (ctx && data.reports.highest_ctr && data.reports.highest_ctr.length > 0) {
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: data.reports.highest_ctr.slice(0, 10).map(p => p.page.substring(0, 30)),
              datasets: [{
                label: 'CTR %',
                data: data.reports.highest_ctr.slice(0, 10).map(p => p.ctr),
                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                title: { display: true, text: 'Top 10 Pages by CTR', color: '#e7eaf3' }
              },
              scales: {
                y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: '#1f2a44' } },
                x: { ticks: { color: '#a0aec0', maxRotation: 45, minRotation: 45 }, grid: { color: '#1f2a44' } }
              }
            }
          });
        }
      }, 200);
      
      return html;
    }
    
    // Historical Reports
    function saveReportToHistory(data) {
      try {
        const history = JSON.parse(localStorage.getItem('gsc_reports_history') || '[]');
        const report = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          period: data.period,
          property: document.getElementById('propertySelect').value,
          summary: {
            avg_position_change: data.avg_position_change,
            total_reports: Object.keys(data.reports).length
          }
        };
        history.unshift(report);
        if (history.length > 20) history.pop(); // Keep last 20
        localStorage.setItem('gsc_reports_history', JSON.stringify(history));
      } catch (e) {
        console.error('Error saving report history:', e);
      }
    }
    
    function loadReportHistory() {
      try {
        const history = JSON.parse(localStorage.getItem('gsc_reports_history') || '[]');
        if (history.length === 0) return '';
        
        let html = '<div class="saved-reports">';
        html += '<h3>Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡</h3>';
        history.forEach(report => {
          html += `
            <div class="saved-report-item" onclick="loadHistoricalReport(${report.id})">
              <div>
                <strong>${report.property}</strong>
                <div style="color: #a0aec0; font-size: 12px; margin-top: 4px;">
                  ${report.period} - ${new Date(report.timestamp).toLocaleString('fa-IR')}
                </div>
              </div>
              <div style="color: #10b981;">
                ØªØºÛŒÛŒØ± Position: ${report.summary.avg_position_change > 0 ? '+' : ''}${report.summary.avg_position_change}
              </div>
            </div>
          `;
        });
        html += '</div>';
        return html;
      } catch (e) {
        return '';
      }
    }
    
    function loadHistoricalReport(reportId) {
      // This would load a saved report - for now just show message
      showMessage('Ú¯Ø²Ø§Ø±Ø´Ø§Øª ØªØ§Ø±ÛŒØ®ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª', 'info');
    }
    
    // Email Modal Functions
    function openEmailModal() {
      if (!currentReportsData) {
        showMessage('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© Ú¯Ø²Ø§Ø±Ø´ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      document.getElementById('emailModal').style.display = 'block';
      document.getElementById('emailInput').focus();
    }
    
    function closeEmailModal() {
      document.getElementById('emailModal').style.display = 'none';
      document.getElementById('emailInput').value = '';
    }
    
    function sendReportByEmail() {
      const email = document.getElementById('emailInput').value.trim();
      
      if (!email) {
        showMessage('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      // Show loading
      const sendBtn = event.target;
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';
      
      fetch('/search-console/reports/email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          report_data: currentReportsData
        })
      })
      .then(response => response.json())
      .then(data => {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
        
        if (data.error) {
          showMessage(data.error, 'error');
        } else {
          showMessage(data.message || 'Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯', 'success');
          closeEmailModal();
        }
      })
      .catch(error => {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
        showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„: ' + error.message, 'error');
      });
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('emailModal');
      if (event.target === modal) {
        closeEmailModal();
      }
    }
    
    function displayInternalLinks(data) {
      const reportsArea = document.getElementById('reportsArea');
      let html = '';
      
      if (data.highest_internal_links && data.highest_internal_links.length > 0) {
        html += `
          <div class="report-section">
            <h3>5 ØµÙØ­Ù‡ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Internal Links</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Internal Links</th>
                  <th>Impressions</th>
                  <th>Clicks</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.highest_internal_links.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.internal_links}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      if (data.lowest_internal_links && data.lowest_internal_links.length > 0) {
        html += `
          <div class="report-section">
            <h3>5 ØµÙØ­Ù‡ Ø¨Ø§ Ú©Ù…ØªØ±ÛŒÙ† Internal Links</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Internal Links</th>
                  <th>Impressions</th>
                  <th>Clicks</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.lowest_internal_links.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.internal_links}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      if (html) {
        reportsArea.innerHTML = html + '<p style="color: #a0aec0; margin-top: 16px;">ØªØ¹Ø¯Ø§Ø¯ ØµÙØ­Ø§Øª ØªØ­Ù„ÛŒÙ„ Ø´Ø¯Ù‡: ' + data.total_pages_analyzed + '</p>';
      }
    }
    
    function searchPagesByQuery() {
      const siteUrl = document.getElementById('propertySelect').value;
      const days = document.getElementById('daysSelect').value;
      const query = document.getElementById('queryInput').value.trim();
      const btn = document.getElementById('querySearchBtn');
      
      if (!siteUrl) {
        showMessage('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Property Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      if (!query) {
        showMessage('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Query ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...';
      
      const reportsArea = document.getElementById('reportsArea');
      reportsArea.innerHTML = '<div class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ ØµÙØ­Ø§Øª...</div>';
      
      fetch('/search-console/reports/pages-by-query', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          site_url: siteUrl,
          query: query,
          days: parseInt(days)
        })
      })
      .then(response => response.json())
      .then(data => {
        btn.disabled = false;
        btn.textContent = 'Ø¬Ø³ØªØ¬ÙˆÛŒ ØµÙØ­Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Query';
        
        if (data.error) {
          showMessage(data.error, 'error');
          reportsArea.innerHTML = '';
          return;
        }
        
        displayPagesByQuery(data);
      })
      .catch(error => {
        btn.disabled = false;
        btn.textContent = 'Ø¬Ø³ØªØ¬ÙˆÛŒ ØµÙØ­Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ Query';
        showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: ' + error.message, 'error');
        reportsArea.innerHTML = '';
      });
    }
    
    function displayPagesByQuery(data) {
      const reportsArea = document.getElementById('reportsArea');
      let html = '';
      
      html += `
        <div class="summary-box">
          <h4>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Query: "${data.query}"</h4>
          <div class="summary-item">
            <span class="summary-label">Exact Match (Ú©Ù„):</span>
            <span class="summary-value">${data.exact.total} ØµÙØ­Ù‡</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Contain Match (Ú©Ù„):</span>
            <span class="summary-value">${data.contain.total} ØµÙØ­Ù‡</span>
          </div>
        </div>
      `;
      
      // Exact Match - Top 5
      if (data.exact.top5 && data.exact.top5.length > 0) {
        html += `
          <div class="report-section">
            <h3>Exact Match - 5 ØµÙØ­Ù‡ Ø§ÙˆÙ„ (Ø¨Ø± Ø§Ø³Ø§Ø³ Clicks)</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Clicks</th>
                  <th>Impressions</th>
                  <th>CTR</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.exact.top5.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.ctr}%</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      // Exact Match - Bottom 5
      if (data.exact.bottom5 && data.exact.bottom5.length > 0) {
        html += `
          <div class="report-section">
            <h3>Exact Match - 5 ØµÙØ­Ù‡ Ø¢Ø®Ø± (Ø¨Ø± Ø§Ø³Ø§Ø³ Clicks)</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Clicks</th>
                  <th>Impressions</th>
                  <th>CTR</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.exact.bottom5.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.ctr}%</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      // Contain Match - Top 5
      if (data.contain.top5 && data.contain.top5.length > 0) {
        html += `
          <div class="report-section">
            <h3>Contain Match (URL Ø´Ø§Ù…Ù„ Query) - 5 ØµÙØ­Ù‡ Ø§ÙˆÙ„ (Ø¨Ø± Ø§Ø³Ø§Ø³ Clicks)</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Clicks</th>
                  <th>Impressions</th>
                  <th>CTR</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.contain.top5.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.ctr}%</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      // Contain Match - Bottom 5
      if (data.contain.bottom5 && data.contain.bottom5.length > 0) {
        html += `
          <div class="report-section">
            <h3>Contain Match (URL Ø´Ø§Ù…Ù„ Query) - 5 ØµÙØ­Ù‡ Ø¢Ø®Ø± (Ø¨Ø± Ø§Ø³Ø§Ø³ Clicks)</h3>
            <table>
              <thead>
                <tr>
                  <th>ØµÙØ­Ù‡</th>
                  <th>Clicks</th>
                  <th>Impressions</th>
                  <th>CTR</th>
                  <th>Position</th>
                </tr>
              </thead>
              <tbody>
        `;
        data.contain.bottom5.forEach(page => {
          html += `
            <tr>
              <td class="page-url" title="${page.page}">${page.page}</td>
              <td>${page.clicks.toLocaleString()}</td>
              <td>${page.impressions.toLocaleString()}</td>
              <td>${page.ctr}%</td>
              <td>${page.position}</td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
      }
      
      if (!html || html === '<div class="summary-box">') {
        html += '<div class="empty-state"><div class="empty-state-icon">ğŸ“­</div><p>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p></div>';
      }
      
      reportsArea.innerHTML = html;
    }
  </script>
</body>
</html>
